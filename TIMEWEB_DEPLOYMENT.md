# Развертывание Fuddly на Timeweb Cloud

## Структура Docker конфигурации

Проект настроен для развертывания на Timeweb Cloud с использованием Docker Compose.

### Файлы конфигурации:
- `docker-compose.yml` - оркестрация сервисов (в корне)
- `Dockerfile.frontend` - сборка frontend (в корне)
- `Dockerfile.backend` - сборка backend (в корне)
- `.dockerignore` - исключение файлов из образов

## Архитектура

```
┌─────────────────┐
│  Timeweb Cloud  │
│   (Проксирование)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌─────────────────┐
│   Frontend      │      │    Backend      │
│   (serve)       │◄────►│   (Express)     │
│   Порт: 8080    │      │   Порт: 3003    │
└─────────────────┘      └────────┬────────┘
                                  │
                                  ▼
                         ┌─────────────────┐
                         │    Supabase     │
                         │   (PostgreSQL)  │
                         └─────────────────┘
```

## Особенности конфигурации для Timeweb Cloud

### ✅ Соответствие требованиям:
1. **docker-compose.yml в корне** - ✅
2. **Dockerfile в корне** - ✅ (Dockerfile.frontend и Dockerfile.backend)
3. **Порты не 80/443** - ✅ (используются 8080 и 3003)
4. **Frontend первый сервис** - ✅ (для проксирования)
5. **Нет volumes** - ✅
6. **Нет privileged/devices** - ✅
7. **Не используется host сеть** - ✅ (bridge network)

### Порты:
- **Frontend**: 8080 (первый сервис - получит проксирование от Timeweb)
- **Backend**: 3003

## Пошаговая инструкция по развертыванию

### 1. Подготовка репозитория

Закоммитьте все изменения:
```bash
git add .
git commit -m "Add Docker configuration for Timeweb Cloud"
git push origin main
```

### 2. Настройка Supabase

Если еще не настроили:
1. Создайте проект на [supabase.com](https://supabase.com)
2. Выполните SQL из `backend/supabase/schema.sql`
3. Сохраните учетные данные:
   - URL проекта
   - Anon (public) key
   - Service role key

### 3. Развертывание на Timeweb Cloud

#### Шаг 1: Создание приложения
1. Войдите в панель Timeweb Cloud
2. Перейдите в раздел **"Приложения"** → **"Docker"**
3. Нажмите **"Создать приложение"**

#### Шаг 2: Подключение репозитория
1. Выберите **"Из Git репозитория"**
2. Подключите ваш GitHub/GitLab аккаунт
3. Выберите репозиторий `fuddly_supabase`
4. Выберите ветку `main`

#### Шаг 3: Настройка сборки
1. **Путь к docker-compose.yml**: `/` (корень)
2. **Автоматическая сборка**: Включите для автодеплоя при push

#### Шаг 4: Переменные окружения

Добавьте следующие переменные окружения в настройках приложения:

```env
# Supabase Configuration
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_KEY=your-service-role-key-here

# Node Environment
NODE_ENV=production
```

⚠️ **ВАЖНО**: Замените значения на ваши реальные ключи из Supabase!

#### Шаг 5: Запуск
1. Нажмите **"Создать и запустить"**
2. Дождитесь завершения сборки (может занять 5-10 минут)
3. После успешной сборки получите URL вашего приложения

### 4. Проверка работоспособности

После развертывания проверьте:

1. **Frontend**: откройте URL приложения от Timeweb
   - Должна открыться главная страница

2. **Backend API**:
   - Health check: `https://your-app.timeweb.cloud/api/health` (через проксирование frontend)
   - Или напрямую, если Timeweb предоставит отдельный URL для backend

3. **Авторизация**:
   - Попробуйте зарегистрироваться
   - Войдите в систему

## Структура сервисов

### Frontend (serve)
- Раздает собранную статику из `dist/`
- Порт: 8080
- Получает проксирование от Timeweb Cloud (как первый сервис)

### Backend (Express)
- Node.js приложение
- Порт: 3003
- Подключается к Supabase
- Доступен внутри Docker сети для Frontend

## API запросы

Frontend делает запросы к Backend через внутреннюю Docker сеть:
- В docker-compose: `http://backend:3003`
- Снаружи через Timeweb: автоматическое проксирование

## Логи и мониторинг

В панели Timeweb Cloud можно:
1. Просматривать логи контейнеров
2. Проверять статус сервисов
3. Перезапускать контейнеры при необходимости

## Обновление приложения

### Автоматическое:
При включенной автосборке - просто делайте `git push`, Timeweb автоматически пересоберет и задеплоит.

### Ручное:
1. В панели Timeweb найдите ваше приложение
2. Нажмите **"Пересобрать"**
3. Дождитесь завершения сборки

## Troubleshooting

### Проблема: Frontend не загружается
**Решение**:
- Проверьте логи frontend контейнера
- Убедитесь что сборка прошла успешно
- Проверьте что порт 8080 открыт

### Проблема: API запросы не работают
**Решение**:
- Проверьте переменные окружения (SUPABASE_*)
- Проверьте логи backend контейнера
- Убедитесь что backend контейнер запущен

### Проблема: Ошибки подключения к Supabase
**Решение**:
- Проверьте правильность SUPABASE_URL
- Проверьте ключи (ANON_KEY, SERVICE_KEY)
- Убедитесь что SQL схема применена
- Проверьте RLS политики в Supabase

### Проблема: 502 Bad Gateway
**Решение**:
- Backend может быть не готов - дождитесь полного запуска
- Проверьте health endpoint: `/health`
- Проверьте логи обоих контейнеров

## Масштабирование

В будущем можно:
1. Добавить Redis для кэширования
2. Настроить CDN для статики
3. Добавить load balancer при росте нагрузки

## Полезные ссылки

- [Документация Timeweb Cloud](https://timeweb.cloud/docs)
- [Документация Supabase](https://supabase.com/docs)
- [Docker Compose reference](https://docs.docker.com/compose/)
